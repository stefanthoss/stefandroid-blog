<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Fix High Latency When Maxing out Upload Bandwidth on pfSense | Stefandroid Blog</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Fix High Latency When Maxing out Upload Bandwidth on pfSense" />
<meta name="author" content="Stefan Thoss" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="High latency and packet loss on pfSense can be caused by bufferbloat and fixed using a bandwidth limiter." />
<meta property="og:description" content="High latency and packet loss on pfSense can be caused by bufferbloat and fixed using a bandwidth limiter." />
<link rel="canonical" href="https://blog.stefandroid.com/2021/03/12/pfsense-high-latency-bufferbloat.html" />
<meta property="og:url" content="https://blog.stefandroid.com/2021/03/12/pfsense-high-latency-bufferbloat.html" />
<meta property="og:site_name" content="Stefandroid Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fix High Latency When Maxing out Upload Bandwidth on pfSense" />
<meta name="google-site-verification" content="IfD8jtnHx4mJpYOmj73jbGqeMSrR8K9C5AIUW6p0Uzs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Stefan Thoss"},"dateModified":"2024-12-07T05:28:15+00:00","datePublished":"2021-03-12T00:00:00+00:00","description":"High latency and packet loss on pfSense can be caused by bufferbloat and fixed using a bandwidth limiter.","headline":"Fix High Latency When Maxing out Upload Bandwidth on pfSense","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.stefandroid.com/2021/03/12/pfsense-high-latency-bufferbloat.html"},"url":"https://blog.stefandroid.com/2021/03/12/pfsense-high-latency-bufferbloat.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.stefandroid.com/feed.xml" title="Stefandroid Blog" /><meta http-equiv="Content-Security-Policy" content="base-uri 'self'; default-src 'self' 'unsafe-inline' *.stefandroid.com;" />
  <script async defer data-domain="blog.stefandroid.com" src="https://stats.stefandroid.com/js/plausible.js" data-exclude="/last-comments"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Stefandroid Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Fix High Latency When Maxing out Upload Bandwidth on pfSense</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-03-12T00:00:00+00:00" itemprop="datePublished">
        Mar 12, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>If you max out the upload bandwidth that your Internet connection provides, you might experience degraded performance on
your pfSense router. You will see high latency/ping (RTT) and high packet loss. The clients accessing the Internet will
experience slow-loading web pages, distorted video/voice calls, and unresponsive behavior. This is known as
<a href="https://www.bufferbloat.net/projects/bloat/wiki/Introduction/">bufferbloat</a> and is basically traffic piling up on the
router due to the Internet upload bandwith being limiting to outgoing traffic.</p>

<p>Here’s a screenshot of my pfSense dashboard when I max out the 20 Mbit/s upload of my Cable Internet connection, showing
a RTT of over 100ms and 14% packet loss:</p>

<p><img src="/assets/images/pfsense-wan-gateway-packetloss.png" alt="pfSense WAN gateway with high latency and packetloss" /></p>

<p>In pfSense’s <strong>Status</strong> → <strong>System Logs</strong> → <strong>Gateways</strong> you will see logs like this:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time             Process   PID     Message
Mar 5 10:54:27   dpinger   38533   WAN_DHCP: Clear latency 210739us stddev 122030us loss 16%
Mar 5 10:54:15   dpinger   38533   WAN_DHCP: Alarm latency 210585us stddev 121638us loss 21%
Mar 5 10:44:04   dpinger   38533   WAN_DHCP: Clear latency 182806us stddev 113934us loss 18%
Mar 5 10:43:27   dpinger   38533   WAN_DHCP: Alarm latency 194447us stddev 107034us loss 21%
</code></pre></div></div>

<p>The <a href="http://dslreports.com/speedtest">DSL Reports Speed Test</a> is an easy test to measure bufferbloat.</p>

<h2 id="solution">Solution</h2>

<p>Using the <a href="https://docs.netgate.com/pfsense/en/latest/trafficshaper/index.html">pfSense Traffic Shaper</a> you can setup
Controlled Delay (CoDel) queue management. This will help the traffic to flow smoother and without spikes in latency
and packet loss. The pfSense documentation provides
<a href="https://docs.netgate.com/pfsense/en/latest/trafficshaper/altq-scheduler-types.html#codel-active-queue-management">more details on CoDel Active Queue Management</a>.</p>

<p>Netgate uploaded the slide deck <a href="https://www.slideshare.net/NetgateUSA/pfsense-244-short-topic-miscellany-pfsense-hangout-august-2018">pfSense Hangout August 2018</a>
which describes the CoDel limiter setup on slide 5 to 11. I provide a summary of that in the following section.</p>

<h2 id="codel-setup">CoDel Setup</h2>

<p>The following description is for a pfSense 2.5.0 firewall using an IPv4 WAN gateway. If you have an IPv6 WAN gateway,
you’ll have to take additional steps that I’m not documenting.</p>

<p>Go to <strong>Firewall</strong> → <strong>Traffic Shaper</strong> → <strong>Limiters</strong> → <strong>New Limiter</strong> and add the following limiter:</p>

<table>
  <tbody>
    <tr>
      <td>Enable</td>
      <td>[x] Enable</td>
    </tr>
    <tr>
      <td>Name</td>
      <td>WanDownload</td>
    </tr>
    <tr>
      <td>Bandwith</td>
      <td>?? Mbit/s, Schedule: none</td>
    </tr>
    <tr>
      <td>Mask</td>
      <td>None</td>
    </tr>
    <tr>
      <td>Queue Management Algorithm</td>
      <td>CoDel</td>
    </tr>
    <tr>
      <td>Scheduler</td>
      <td>FQ_CODEL</td>
    </tr>
    <tr>
      <td>Queue length</td>
      <td>1000</td>
    </tr>
    <tr>
      <td>ECN</td>
      <td>[x] Enable</td>
    </tr>
  </tbody>
</table>

<p>Adapt the bandwith to the download bandwith of your Internet connection. Leave everything else and the Advanced Options
empty. After you saved the limiter, click <strong>Add new Queue</strong> and enter the following configuration:</p>

<table>
  <tbody>
    <tr>
      <td>Enable</td>
      <td>[x] Enable</td>
    </tr>
    <tr>
      <td>Name</td>
      <td>DownloadQueue</td>
    </tr>
    <tr>
      <td>Mask</td>
      <td>None</td>
    </tr>
    <tr>
      <td>Queue Management Algorithm</td>
      <td>CoDel</td>
    </tr>
    <tr>
      <td>ECN</td>
      <td>[x] Enable</td>
    </tr>
  </tbody>
</table>

<p>Leave everything else and the Advanced Options empty. Save the queue.</p>

<p>Repeat the above limiter and queue creations for the upload - creating a <strong>WanUpload</strong> limiter with an <strong>UploadQueue</strong>
queue. Use the upload bandwith of your Internet connection for the upload limiter. The Traffic Shaper Limiter page
should look like this:</p>

<p><img src="/assets/images/pfsense-limiter-queue.png" alt="pfSense Traffic Shaper Limiters" /></p>

<p>Now go to <strong>Firewall</strong> → <strong>Rules</strong> → <strong>Floating</strong> → <strong>Add</strong> and add a floating rule with the following configuration:</p>

<table>
  <tbody>
    <tr>
      <td>Action</td>
      <td>Pass</td>
    </tr>
    <tr>
      <td>Quick</td>
      <td>[x] Apply the action immediately on match.</td>
    </tr>
    <tr>
      <td>Interface</td>
      <td>WAN</td>
    </tr>
    <tr>
      <td>Direction</td>
      <td>out</td>
    </tr>
    <tr>
      <td>Address Family</td>
      <td>IPv4</td>
    </tr>
    <tr>
      <td>Protocol</td>
      <td>Any</td>
    </tr>
    <tr>
      <td>Source</td>
      <td>any</td>
    </tr>
    <tr>
      <td>Destination</td>
      <td>any</td>
    </tr>
    <tr>
      <td>Description</td>
      <td>CoDel Limiters</td>
    </tr>
    <tr>
      <td>Advanced Options</td>
      <td>Display Advanced</td>
    </tr>
    <tr>
      <td>Gateway</td>
      <td>WAN_DHCP - Interface WAN_DHCP Gateway</td>
    </tr>
    <tr>
      <td>In / Out pipe</td>
      <td>UploadQueue / DownloadQueue</td>
    </tr>
  </tbody>
</table>

<p>Save the rule and apply changes. You’re done and shouldn’t experience bufferbloat anymore!</p>

<h2 id="limiter-bandwidth-testing">Limiter Bandwidth Testing</h2>

<p>My Cable Internet connection is marketed as 400 Mbit/s download and 20 Mbit/s upload. Based on my speed tests it is in
reality closer to 420 Mbit/s download and 22 MBit/s upload (I know - very surprising!). I want to find out how I should
configure the limiter’s upload bandwidth - slightly above or slightly below the actual upload throughput? I’ll be
focussing on the upload only since I’m not experiencing noticeable bufferbloat with my download connection.</p>

<p>First I run a test with a 25 Mbit/s <strong>WanUpload</strong> limiter (slightly above the actual upload throughput):</p>

<p><img src="/assets/images/pfsense-wan-gateway-high-latency.png" alt="pfSense WAN gateway with high latency but no packetloss" /></p>

<p>I’m still experiencing high latency but no packet loss anymore. It seems that the limiter is preventing the packet loss
but it can’t do anything about the latency - the Internet connection is still too slow for the amount of data I’m trying
to push.</p>

<p>Now I run a test with a 20 Mbit/s <strong>WanUpload</strong> limiter (slightly below the actual upload throughput):</p>

<p><img src="/assets/images/pfsense-wan-gateway-low-latency.png" alt="pfSense WAN gateway without latency and packetloss" /></p>

<p>This looks much better. I might leave a bit of upload throughput on the table, but I finally see low latency and no
packet loss even under maximum upload stress. You should definitely set your limiter bandwidth slightly below your
actual upload throughput to avoid both high latency and packet loss.</p>

  </div>

  <div id="remark42"></div>

  <a class="u-url" href="/2021/03/12/pfsense-high-latency-bufferbloat.html" hidden></a>
</article>

<script>
  var remark_config = {
    host: 'https://remark.stefandroid.com',
    site_id: 'STEFANDROID_BLOG',
    components: ['embed'],
    url: 'https://blog.stefandroid.com/2021/03/12/pfsense-high-latency-bufferbloat.html',
    theme: 'light',
    locale: 'en',
    show_email_subscription: false
  };
</script>
<script>!function(e,n){for(var o=0;o<e.length;o++){var r=n.createElement("script"),c=".js",d=n.head||n.body;"noModule"in r?(r.type="module",c=".mjs"):r.async=!0,r.defer=!0,r.src=remark_config.host+"/web/"+e[o]+c,d.appendChild(r)}}(remark_config.components||["embed"],document);</script>

      </div>
    </main><footer class="site-footer h-card">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          
        </ul>
      </div>
    </div>

    <div class="social-links">
      <ul class="social-media-list"><li><a href="https://github.com/stefanthoss" target="_blank"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">stefanthoss</span></a></li><li><a rel="me" href="https://sfba.social/@stefandroid" target="_blank"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#mastodon"></use></svg> <span>Mastodon</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>Subscribe via Atom</span></a></li></ul>      
    </div>

  </div>

</footer>
</body>

</html>
