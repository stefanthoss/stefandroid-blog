<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Use Plex Media Server with a Let’s Encrypt Certificate | Stefandroid Blog</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Use Plex Media Server with a Let’s Encrypt Certificate" />
<meta name="author" content="Stefan Thoss" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The connection to your Plex Media Server can be secured with a Let’s Encrypt certificate and certificate auto-renewal through certbot." />
<meta property="og:description" content="The connection to your Plex Media Server can be secured with a Let’s Encrypt certificate and certificate auto-renewal through certbot." />
<link rel="canonical" href="https://blog.stefandroid.com/2021/08/27/plex-with-lets-encrypt-certificate.html" />
<meta property="og:url" content="https://blog.stefandroid.com/2021/08/27/plex-with-lets-encrypt-certificate.html" />
<meta property="og:site_name" content="Stefandroid Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Use Plex Media Server with a Let’s Encrypt Certificate" />
<meta name="google-site-verification" content="IfD8jtnHx4mJpYOmj73jbGqeMSrR8K9C5AIUW6p0Uzs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Stefan Thoss"},"dateModified":"2024-12-07T05:28:15+00:00","datePublished":"2021-08-27T00:00:00+00:00","description":"The connection to your Plex Media Server can be secured with a Let’s Encrypt certificate and certificate auto-renewal through certbot.","headline":"Use Plex Media Server with a Let’s Encrypt Certificate","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.stefandroid.com/2021/08/27/plex-with-lets-encrypt-certificate.html"},"url":"https://blog.stefandroid.com/2021/08/27/plex-with-lets-encrypt-certificate.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.stefandroid.com/feed.xml" title="Stefandroid Blog" /><meta http-equiv="Content-Security-Policy" content="base-uri 'self'; default-src 'self' 'unsafe-inline' *.stefandroid.com;" />
  <script async defer data-domain="blog.stefandroid.com" src="https://stats.stefandroid.com/js/plausible.js" data-exclude="/last-comments"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Stefandroid Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Use Plex Media Server with a Let&#39;s Encrypt Certificate</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-08-27T00:00:00+00:00" itemprop="datePublished">
        Aug 27, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>You can use a free <a href="https://letsencrypt.org">Let’s Encrypt</a> certificate for your
<a href="/2021/07/17/install-plex-on-debian.html">self-hosted Plex Media Server VM</a>. With
<a href="https://certbot.eff.org">Certbot</a> and a simple Bash script, this will provide a secure connection without certificate
warnings. It will also auto-renew certificates. I’m using Debian Bullseye, but this will work on any Linux distribution.</p>

<h2 id="motivation">Motivation</h2>

<p>There are two possible options how to secure the connection to your Plex server when exposing it to the public Internet:</p>

<ol>
  <li>Use a reverse proxy like HAProxy or nginx that forwards the traffic and performs SSL offloading.</li>
  <li>Use Plex’s remote access feature and forward the port on your firewall directly to your Plex server.</li>
</ol>

<p>Generally I would prefer the reverse proxy since I can use my existing reverse proxy which already has a valid Let’s
Encrypt certificate. Also, I have more control on how the server is exposed to the public Internet. Unfortunately, a few
Plex features like the Sonos integration and the mobile Plex apps are not working with this setup since they need direct
access. So I chose the remote access (reverse proxy will work fine if those features are not important for you). The
following guide will explain how to use a valid Let’s Encrypt certificate with Plex remote access.</p>

<h2 id="setup">Setup</h2>

<p>First, install Certbot. The EFF provides <a href="https://certbot.eff.org/instructions">installation guides</a> for multiple
operating systems. For Debian the official recommendation is using Snap:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>snapd
<span class="nb">sudo </span>snap refresh core
<span class="nb">sudo </span>snap <span class="nb">install</span> <span class="nt">--classic</span> certbot
<span class="nb">sudo ln</span> <span class="nt">-s</span> /snap/bin/certbot /usr/bin/certbot
</code></pre></div></div>

<h2 id="http-or-dns-lets-encrypt-challenge">HTTP or DNS Let’s Encrypt Challenge</h2>

<p>Verification of the domain can either be done via an HTTP challenge or a DNS challenge. I choose a
<a href="https://certbot.eff.org/docs/using.html#dns-plugins">DNS challenge</a> because it doesn’t require opening port 80 to the
public Internet. In the following, I use a DNS challenge using Cloudflare. The rest of this guide works the same, even
when you choose to use a different type of challenge or a different DNS provider.</p>

<p>Install the <a href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/">DNS Cloudflare plugin</a>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>snap <span class="nb">set </span>certbot trust-plugin-with-root<span class="o">=</span>ok
<span class="nb">sudo </span>snap <span class="nb">install </span>certbot-dns-cloudflare
</code></pre></div></div>

<p>Create the file <code class="language-plaintext highlighter-rouge">~/.secrets/certbot/cloudflare.ini</code> with the API token you created in your Cloudflare account:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">dns_cloudflare_api_token</span> <span class="p">=</span> <span class="s">SECRET_TOKEN</span>
</code></pre></div></div>

<h2 id="pkcs-12-certificate">PKCS #12 Certificate</h2>

<p>Certbot generates a private key file, a certificate file, and the CA file. By default, these files get created in
<code class="language-plaintext highlighter-rouge">/etc/letsencrypt/live/plex.example.com/</code>. Plex however, expects a PKCS #12 certificate file that bundles all of these
together. I created a script that is triggered by Certbot’s renewal hook, which will convert the Certbot output into a
PKCS #12 certificate file that is compatible with Plex.</p>

<p>In the following, I’m using <code class="language-plaintext highlighter-rouge">plex.example.com</code> as a domain, replace this with your own domain name. Also replace
<code class="language-plaintext highlighter-rouge">PASSWORD</code> with a random password of your choice.</p>

<p>Create the <code class="language-plaintext highlighter-rouge">/etc/letsencrypt/renewal-hooks/post/create_p12_file.sh</code> file with the following content:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

openssl pkcs12 <span class="nt">-export</span> <span class="se">\</span>
  <span class="nt">-out</span> /var/lib/plexmediaserver/plex_certificate.p12 <span class="se">\</span>
  <span class="nt">-in</span> /etc/letsencrypt/live/plex.example.com/cert.pem <span class="se">\</span>
  <span class="nt">-inkey</span> /etc/letsencrypt/live/plex.example.com/privkey.pem <span class="se">\</span>
  <span class="nt">-certfile</span> /etc/letsencrypt/live/plex.example.com/chain.pem <span class="se">\</span>
  <span class="nt">-passout</span> pass:PASSWORD <span class="se">\</span>
  <span class="nt">-certpbe</span> AES-256-CBC <span class="nt">-keypbe</span> AES-256-CBC <span class="nt">-macalg</span> SHA256

<span class="nb">chmod </span>755 /var/lib/plexmediaserver/plex_certificate.p12
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">chmod</code> command is necessary because this Bash script will be executed as root and the Plex user has to be able to
access the file. After the creation of the script file, use <code class="language-plaintext highlighter-rouge">sudo chmod +x /etc/letsencrypt/renewal-hooks/post/create_p12_file.sh</code>
to make it executable.</p>

<p>Now you can initialize Certbot and obtain the first Let’s Encrypt certificate:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>certbot certonly <span class="se">\</span>
  <span class="nt">--dns-cloudflare</span> <span class="se">\</span>
  <span class="nt">--dns-cloudflare-credentials</span> ~/.secrets/certbot/cloudflare.ini <span class="se">\</span>
  <span class="nt">-m</span> youremail@example.com <span class="se">\</span>
  <span class="nt">-d</span> plex.example.com
</code></pre></div></div>

<p>Every time the certificate is close to experiation, Certbot should renew the certificate and regenerate the
<code class="language-plaintext highlighter-rouge">/var/lib/plexmediaserver/plex_certificate.p12</code> file using the renewal hook. To achieve this, install a cronjob using
this command (see <a href="https://certbot.eff.org/docs/using.html#setting-up-automated-renewal">Certbot automated renewals</a>
for details):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SLEEPTIME</span><span class="o">=</span><span class="si">$(</span><span class="nb">awk</span> <span class="s1">'BEGIN{srand(); print int(rand()*(3600+1))}'</span><span class="si">)</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"0 0,12 * * * root sleep </span><span class="nv">$SLEEPTIME</span><span class="s2"> &amp;&amp; certbot renew -q"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/crontab <span class="o">&gt;</span> /dev/null
</code></pre></div></div>

<p>For testing, you can use <code class="language-plaintext highlighter-rouge">sudo certbot renew --force-renewal</code> to force a renewal and trigger the post renewal hook.</p>

<h2 id="use-the-lets-encrypt-certificate-in-plex">Use the Let’s Encrypt Certificate in Plex</h2>

<p>Go to the “Network” tab of the Plex settings. Set the following configuration (replace <code class="language-plaintext highlighter-rouge">PASSWORD</code> and <code class="language-plaintext highlighter-rouge">plex.example.com</code>):</p>

<ul>
  <li>Secure connections: Required</li>
  <li>Custom certificate location: <code class="language-plaintext highlighter-rouge">/var/lib/plexmediaserver/plex_certificate.p12</code></li>
  <li>Custom certificate encryption key: <code class="language-plaintext highlighter-rouge">PASSWORD</code></li>
  <li>Custom certificate domain: <code class="language-plaintext highlighter-rouge">plex.example.com</code></li>
  <li>Enable Strict TLS configuration</li>
  <li>Custom server access URLs: <code class="language-plaintext highlighter-rouge">https://plex.example.com:32400</code></li>
</ul>

<p><img src="/assets/images/plex-network-p12-certificate.png" alt="Plex Network PKCS #12 Certificate" /></p>

<h2 id="dns-resolution-and-port-fowarding">DNS Resolution and Port Fowarding</h2>

<p>The last step is to set up DNS resolution and port forwarding. I’m not going into great detail here because it depends
on both your DNS provider and your firewall.</p>

<p>In summary, ensure that your domain <code class="language-plaintext highlighter-rouge">plex.example.com</code> resolves to your public IP and forward port 32400 on the public
IP to port 32400 of the Plex VM. In case you use pfSense you have to
<a href="https://docs.netgate.com/pfsense/en/latest/firewall/rule-list-intro.html">add a firewall rule</a> on the WAN interface.
Make sure you are familiar with the security risks of opening a public port before configuring anything on your firewall.</p>

<h2 id="last-steps">Last Steps</h2>

<p>Go to the “Remote Access” tab of the Plex settings and enable remote access. If you see the message</p>

<blockquote>
  <p>Fully accessible outside your network</p>
</blockquote>

<p>your setup is working!</p>

<h2 id="update-april-20-2023-openssl-30">Update (April 20, 2023): OpenSSL 3.0</h2>

<p>With Plex 1.32.0.6865, OpenSSL was updated to 3.0 which requires different encryption algorithms to be used. If the
<code class="language-plaintext highlighter-rouge">create_p12_file.sh</code> script does not explicitly use stricter encryption algorithms, the Plex server will use the
default <code class="language-plaintext highlighter-rouge">.plex.direct</code> certificate instead of the custom certificate. This will result in a browser security warning
and the following Plex server log lines:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR - [CERT] PKCS12_parse failed: error:digital envelope routines::unsupported
ERROR - [CERT] Found a user-provided certificate, but couldn't install it.
</code></pre></div></div>

<p>Based on the article in <a href="https://forums.plex.tv/t/linux-tips/276247/25">https://forums.plex.tv/t/linux-tips/276247/25</a>, it can be fixed by adding
<code class="language-plaintext highlighter-rouge">-certpbe AES-256-CBC -keypbe AES-256-CBC -macalg SHA256</code> to the <code class="language-plaintext highlighter-rouge">openssl pkcs12</code> command – I updated the post above
accordingly.</p>

  </div>

  <div id="remark42"></div>

  <a class="u-url" href="/2021/08/27/plex-with-lets-encrypt-certificate.html" hidden></a>
</article>

<script>
  var remark_config = {
    host: 'https://remark.stefandroid.com',
    site_id: 'STEFANDROID_BLOG',
    components: ['embed'],
    url: 'https://blog.stefandroid.com/2021/08/27/plex-with-lets-encrypt-certificate.html',
    theme: 'light',
    locale: 'en',
    show_email_subscription: false
  };
</script>
<script>!function(e,n){for(var o=0;o<e.length;o++){var r=n.createElement("script"),c=".js",d=n.head||n.body;"noModule"in r?(r.type="module",c=".mjs"):r.async=!0,r.defer=!0,r.src=remark_config.host+"/web/"+e[o]+c,d.appendChild(r)}}(remark_config.components||["embed"],document);</script>

      </div>
    </main><footer class="site-footer h-card">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          
        </ul>
      </div>
    </div>

    <div class="social-links">
      <ul class="social-media-list"><li><a href="https://github.com/stefanthoss" target="_blank"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">stefanthoss</span></a></li><li><a rel="me" href="https://sfba.social/@stefandroid" target="_blank"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#mastodon"></use></svg> <span>Mastodon</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>Subscribe via Atom</span></a></li></ul>      
    </div>

  </div>

</footer>
</body>

</html>
