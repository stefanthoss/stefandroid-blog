<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Migrate Smart Plugs from Tasmota to ESPHome | Stefandroid Blog</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Migrate Smart Plugs from Tasmota to ESPHome" />
<meta name="author" content="Stefan Thoss" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="You can replace the firmware of a Tasmota smart plug with ESPHome through the web interface." />
<meta property="og:description" content="You can replace the firmware of a Tasmota smart plug with ESPHome through the web interface." />
<link rel="canonical" href="https://blog.stefandroid.com/2024/08/20/migrate-tasmota-to-esphome.html" />
<meta property="og:url" content="https://blog.stefandroid.com/2024/08/20/migrate-tasmota-to-esphome.html" />
<meta property="og:site_name" content="Stefandroid Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-08-20T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Migrate Smart Plugs from Tasmota to ESPHome" />
<meta name="google-site-verification" content="IfD8jtnHx4mJpYOmj73jbGqeMSrR8K9C5AIUW6p0Uzs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Stefan Thoss"},"dateModified":"2024-12-07T05:28:15+00:00","datePublished":"2024-08-20T00:00:00+00:00","description":"You can replace the firmware of a Tasmota smart plug with ESPHome through the web interface.","headline":"Migrate Smart Plugs from Tasmota to ESPHome","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.stefandroid.com/2024/08/20/migrate-tasmota-to-esphome.html"},"url":"https://blog.stefandroid.com/2024/08/20/migrate-tasmota-to-esphome.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.stefandroid.com/feed.xml" title="Stefandroid Blog" /><meta http-equiv="Content-Security-Policy" content="base-uri 'self'; default-src 'self' 'unsafe-inline' *.stefandroid.com;" />
  <script async defer data-domain="blog.stefandroid.com" src="https://stats.stefandroid.com/js/plausible.js" data-exclude="/last-comments"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Stefandroid Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Migrate Smart Plugs from Tasmota to ESPHome</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-08-20T00:00:00+00:00" itemprop="datePublished">
        Aug 20, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’ve been using Tasmota smart plugs for a couple of years, but I’ve recently started migrating them to ESPHome. The
migration can be done entirely over-the-air and does not require physical access to the smart plug.</p>

<p>I prefer ESPHome for a couple of reasons:</p>

<ul>
  <li>The integration in Home Assistant is better.</li>
  <li>You don’t have to manually configure an MQTT broker on the device.</li>
  <li>Updates can be done on multiple devices directly through the Home Assistant add-on (there is the
<a href="https://github.com/hassio-addons/addon-tasmoadmin">TasmoAdmin</a> plug-in, but I didn’t have a good experience with that).</li>
  <li>I already have a couple of ESPHome devices, so they’ll integrate nicely.</li>
  <li>The configuration of ESPHome devices is driven through a config file instead of a web UI.</li>
  <li>ESPHome is much more powerful in terms of configuration and customization. Example: I have a plug where I disabled
the physical switch, using it only for power monitoring.</li>
</ul>

<p>These instructions should work with all Aoycocr-X10S-based smart plugs. I’m using the awesome <a href="https://cloudfree.shop/product/cloudfree-smart-plug-runs-tasmota/">CloudFree Smart Plug 2</a>
which I strongly recommend – that plug is solidly built, costs only $13 as of March 2023, includes power monitoring,
and is rated for up to 15 A / 1800 W. For other Tasmota devices the steps will be roughly the same, but the
configuration file has to be different. Check out <a href="https://www.esphome-devices.com/type/plug">ESPHome Device</a> for a
collection of ESPHome configurations for various devices.</p>

<h2 id="installation">Installation</h2>

<p>The first step is to flash the minimal Tasmota firmware instead of the regular build. If you try to flash ESPHome with
the regular Tasmota firmware, you’ll get an “Upload Failed. Not enough space.” message in Tasmota. Go to your Tasmota
plug’s web UI, select <em>Firmware Upgrade</em> and upgrade by web server using the
<code class="language-plaintext highlighter-rouge">http://ota.tasmota.com/tasmota/tasmota-minimal.bin.gz</code> OTA URL.</p>

<p>Next, go to the Home Assistant ESPHome add-on, click <em>New Device</em>, give the configuration a name, and select the device
type (ESP8266 for the CloudFree P2 plugs). Don’t install it yet.</p>

<p>Now you have to edit the configuration. I’m doing it based on the config that’s outlined in the
<a href="https://www.esphome-devices.com/devices/Aoycocr-X10S-Plug">ESPHome Device page about Aoycocr-X10S</a> but with slight
modifications to the latest ESPHome firmware (2023.3.1 as of this writing). We’re starting off with the default
configuration that ESPHome created for you, which will already include a lot of the best practices, secrets, and WiFi
configuration.</p>

<ol>
  <li>Add <code class="language-plaintext highlighter-rouge">restore_from_flash: true</code> to the <code class="language-plaintext highlighter-rouge">esp8266</code> section. This writes each state change to flash for switch or light
with restore_mode, check out the <a href="https://esphome.io/components/esphome.html#esp8266-restore-from-flash">documentation</a>
for more info.</li>
  <li>Leave the <code class="language-plaintext highlighter-rouge">logger</code>, <code class="language-plaintext highlighter-rouge">api</code>, <code class="language-plaintext highlighter-rouge">ota</code>, <code class="language-plaintext highlighter-rouge">wifi</code>, and <code class="language-plaintext highlighter-rouge">captive_portal</code> section as-is.</li>
  <li>(Optional) Add a comment to the <code class="language-plaintext highlighter-rouge">esphome</code> section to describe the device
(e.g. <code class="language-plaintext highlighter-rouge">comment: CloudFree Smart Plug 2, based on Aoycocr-X10S Plug</code>)</li>
  <li>
    <p>Apend the following config:</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># Enable time component for use by daily power sensor</span>
 <span class="na">time</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">homeassistant</span>
     <span class="na">id</span><span class="pi">:</span> <span class="s">homeassistant_time</span>

 <span class="na">binary_sensor</span><span class="pi">:</span>
   <span class="c1"># Reports when the button is pressed</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">gpio</span>
     <span class="na">device_class</span><span class="pi">:</span> <span class="s">power</span>
     <span class="na">pin</span><span class="pi">:</span>
       <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO13</span>
       <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">Button</span>
     <span class="na">on_press</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">switch.toggle</span><span class="pi">:</span> <span class="s">relay</span>

   <span class="c1"># Reports if this device is Connected or not</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">status</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">Status</span>

 <span class="na">sensor</span><span class="pi">:</span>
   <span class="c1"># Reports the WiFi signal strength</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">wifi_signal</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">WiFi Signal</span>

   <span class="c1"># Reports how long the device has been powered (in minutes)</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">uptime</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">Uptime</span>
     <span class="na">filters</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">return x / 60.0;</span>
     <span class="na">device_class</span><span class="pi">:</span> <span class="s">duration</span>
     <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">min</span>
     <span class="na">state_class</span><span class="pi">:</span> <span class="s">total_increasing</span>

   <span class="c1"># Reports the Current, Voltage, and Power used by the plugged-in device (not counting this plug's own usage of about 0.7W/0.02A, so subtract those when calibrating with this plugged into a Kill-A-Watt type meter)</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">hlw8012</span>
     <span class="na">sel_pin</span><span class="pi">:</span>
       <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO12</span>
       <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>
     <span class="na">cf_pin</span><span class="pi">:</span> <span class="s">GPIO5</span>
     <span class="na">cf1_pin</span><span class="pi">:</span> <span class="s">GPIO14</span>
     <span class="na">current_resistor</span><span class="pi">:</span> <span class="m">0.001</span> <span class="c1">#The value of the shunt resistor for current measurement. Defaults to the Sonoff POW’s value 0.001 ohm. Verified on https://fccid.io/2AKBP-X10S/Internal-Photos/X10S-Int-photo-4308983 that we use "R001" = 0.001 ohm</span>
     <span class="na">voltage_divider</span><span class="pi">:</span> <span class="m">2401</span> <span class="c1">#The value of the voltage divider on the board as (R_upstream + R_downstream) / R_downstream. Defaults to the Sonoff POW’s value 2351. From the pic we use 2x "125" = 2x 1.2Mohm for R_upstream and "102" = 1kohm for R_downstream, so (1,200,000+1,200,000+1,000)/1,000 = 2401</span>
     <span class="c1"># but those don't fix the measurement values, probably because we actually have a BL0937 chip instead of a HLW8012, (and part variance aswell) so we have to manually calibrate with a known load or a load and a Kill-A-Watt type meter. My values used below will only be +/-10% of yours I think.</span>
     <span class="c1"># The comments about the voltage divider were taken from the AWP04L template. I was unable to verify the voltage divider in the Aoycocr X10S plug.</span>
     <span class="na">power</span><span class="pi">:</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s">Power</span>
       <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">W</span>
       <span class="na">id</span><span class="pi">:</span> <span class="s">wattage</span>
       <span class="na">filters</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
             <span class="c1"># Map 0.0 (from sensor) to 0.0 (true value)</span>
             <span class="pi">-</span> <span class="s">0.0 -&gt; </span><span class="m">0.0</span> <span class="c1">#Need to keep 0 mapped to 0 for when connected device is not drawing any power</span>
             <span class="pi">-</span> <span class="s">67.6 -&gt; </span><span class="m">11.0</span> <span class="c1">#Tested using a Kill-A-Watt meter and LED bulb minus 0.7W from just this plug with LED bulb off</span>
         <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">if (id(relay).state) return x; else return 0;</span>
     <span class="na">current</span><span class="pi">:</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s">Current</span>
       <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">A</span>
       <span class="na">filters</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
             <span class="c1"># Map 0.0 (from sensor) to 0.0 (true value)</span>
             <span class="pi">-</span> <span class="s">0.0 -&gt; </span><span class="m">0.0</span> <span class="c1">#Need to keep 0 mapped to 0 for when connected device is not drawing any power</span>
             <span class="pi">-</span> <span class="s">0.12 -&gt; </span><span class="m">0.08</span> <span class="c1">#Tested using a Kill-A-Watt meter and LED bulb minus 0.02A from just this plug with LED bulb off</span>
     <span class="na">voltage</span><span class="pi">:</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s">Voltage</span>
       <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">V</span>
       <span class="na">filters</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
             <span class="c1"># Map 0.0 (from sensor) to 0.0 (true value)</span>
             <span class="pi">-</span> <span class="s">0.0 -&gt; </span><span class="m">0.0</span>
             <span class="pi">-</span> <span class="s">322.4 -&gt; </span><span class="m">118.3</span> <span class="c1">#Tested using a Kill-A-Watt meter, value while connected LED bulb was on</span>
     <span class="na">change_mode_every</span><span class="pi">:</span> <span class="m">1</span> <span class="c1">#Skips first reading after each change, so this will double the update interval. Default 8</span>
     <span class="na">update_interval</span><span class="pi">:</span> <span class="s">10s</span> <span class="c1">#20 second effective update rate for Power, 40 second for Current and Voltage. Default 60s</span>

   <span class="c1"># Reports the total Power so-far each day, resets at midnight, see https://esphome.io/components/sensor/total_daily_energy.html</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">total_daily_energy</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">Total Daily Energy</span>
     <span class="na">power_id</span><span class="pi">:</span> <span class="s">wattage</span>
     <span class="na">filters</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">multiply</span><span class="pi">:</span> <span class="m">0.001</span> <span class="c1">## convert Wh to kWh</span>
     <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">kWh</span>

 <span class="na">text_sensor</span><span class="pi">:</span>
   <span class="c1"># Reports the ESPHome Version with compile date</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">version</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">ESPHome Version</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">wifi_info</span>
     <span class="na">ip_address</span><span class="pi">:</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s">IP Address</span>

 <span class="na">switch</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">gpio</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">Switch</span>
     <span class="na">pin</span><span class="pi">:</span> <span class="s">GPIO4</span>
     <span class="na">id</span><span class="pi">:</span> <span class="s">relay</span>
     <span class="na">restore_mode</span><span class="pi">:</span> <span class="s">ALWAYS_ON</span>
     <span class="c1">#RESTORE_DEFAULT_OFF (Default) - Attempt to restore state and default to OFF if not possible to restore. Uses flash write cycles.</span>
     <span class="c1">#RESTORE_DEFAULT_ON - Attempt to restore state and default to ON. Uses flash write cycles.</span>
     <span class="c1">#ALWAYS_OFF - Always initialize the pin as OFF on bootup. Does not use flash write cycles.</span>
     <span class="c1">#ALWAYS_ON - Always initialize the pin as ON on bootup. Does not use flash write cycles.</span>
     <span class="na">on_turn_on</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">light.turn_on</span><span class="pi">:</span>
           <span class="na">id</span><span class="pi">:</span> <span class="s">blue_led</span>
           <span class="na">brightness</span><span class="pi">:</span> <span class="s">100%</span>
     <span class="na">on_turn_off</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="na">light.turn_off</span><span class="pi">:</span> <span class="s">blue_led</span>

 <span class="na">output</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">esp8266_pwm</span>
     <span class="na">id</span><span class="pi">:</span> <span class="s">blue_output</span>
     <span class="na">pin</span><span class="pi">:</span> <span class="s">GPIO2</span>
     <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>

 <span class="na">light</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">monochromatic</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">Blue LED</span>
     <span class="na">output</span><span class="pi">:</span> <span class="s">blue_output</span>
     <span class="na">id</span><span class="pi">:</span> <span class="s">blue_led</span>
     <span class="na">restore_mode</span><span class="pi">:</span> <span class="s">ALWAYS_OFF</span> <span class="c1">#Start with light off after reboot/power-loss event.</span>
     <span class="na">disabled_by_default</span><span class="pi">:</span> <span class="kc">true</span>

 <span class="na">status_led</span><span class="pi">:</span>
   <span class="na">pin</span><span class="pi">:</span>
     <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO0</span>
     <span class="na">inverted</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div>    </div>
  </li>
  <li>Adapt the <code class="language-plaintext highlighter-rouge">restore_mode</code> of the <code class="language-plaintext highlighter-rouge">switch</code> section to your preferred switch behavior. See comments for descriptions
of the different options.</li>
</ol>

<p>Next, remove the old Tasmota device from Home Assistant, otherwise it mix with the new ESPHome device. Since we already
downgraded to the “minimal” Tasmota firmware, it will no longer publish MQTT messages to the MQTT broker. There are a
couple of ways to do this, the easiest being purging the respective topics in the MQTT broker. I use
<a href="https://mqtt-explorer.com/">MQTT Explorer</a> to delete the topics <code class="language-plaintext highlighter-rouge">/tasmota/discovery/XXXXXXXXXXXX</code> and
<code class="language-plaintext highlighter-rouge">/tele/tasmota_XXXXXX</code> for the device.</p>

<p>Now install ESPHome. Click <em>Install</em>, <em>Manual download</em>, <em>Legacy format</em>, and download the <code class="language-plaintext highlighter-rouge">bin</code> file. Go to your
Tasmota plug’s web UI, select <em>Firmware Upgrade</em> and upgrade by uploading the <code class="language-plaintext highlighter-rouge">bin</code> file. The plug should reboot and
run ESPHome! The final step is to adopt the device in Home Assistant which is easy since Home Assistant auto-detects
the new device.</p>

<p>All future updates can be done directly through the ESPHome add-on.</p>

<p>Helpful links:</p>

<ul>
  <li><a href="https://esphome.io/guides/migrate_sonoff_tasmota.html">https://esphome.io/guides/migrate_sonoff_tasmota.html</a></li>
</ul>

<h2 id="full-configuration-example">Full Configuration Example</h2>

<p>Here’s a full config example I’m using for my espresso machine’s smart plug:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">esphome</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cloudfree-p2-espresso-machine</span>
  <span class="na">friendly_name</span><span class="pi">:</span> <span class="s">CloudFree P2 Espresso Machine</span>
  <span class="na">comment</span><span class="pi">:</span> <span class="s">CloudFree Smart Plug 2, based on Aoycocr-X10S Plug</span>

<span class="na">esp8266</span><span class="pi">:</span>
  <span class="na">board</span><span class="pi">:</span> <span class="s">esp01_1m</span>
  <span class="na">restore_from_flash</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># Enable logging</span>
<span class="na">logger</span><span class="pi">:</span>

<span class="c1"># Enable Home Assistant API</span>
<span class="na">api</span><span class="pi">:</span>
  <span class="na">encryption</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>

<span class="na">ota</span><span class="pi">:</span>
  <span class="na">platform</span><span class="pi">:</span> <span class="s">esphome</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>

<span class="na">wifi</span><span class="pi">:</span>
  <span class="na">ssid</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">wifi_ssid</span>
  <span class="na">password</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">wifi_password</span>

  <span class="c1"># Enable fallback hotspot (captive portal) in case wifi connection fails</span>
  <span class="na">ap</span><span class="pi">:</span>
    <span class="na">ssid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Cloudfree-P2-Espresso-Machine"</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">XXXXXXXXXXXX"</span>

<span class="na">captive_portal</span><span class="pi">:</span>

<span class="c1"># Enable web server</span>
<span class="na">web_server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>

<span class="c1"># Enable time component for use by daily power sensor</span>
<span class="na">time</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">homeassistant</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">homeassistant_time</span>

<span class="na">binary_sensor</span><span class="pi">:</span>
  <span class="c1"># Reports when the button is pressed</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">gpio</span>
    <span class="na">device_class</span><span class="pi">:</span> <span class="s">power</span>
    <span class="na">pin</span><span class="pi">:</span>
      <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO13</span>
      <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Button</span>
    <span class="na">on_press</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">switch.toggle</span><span class="pi">:</span> <span class="s">relay</span>

  <span class="c1"># Reports if this device is Connected or not</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">status</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Status</span>

<span class="na">sensor</span><span class="pi">:</span>
  <span class="c1"># Reports the WiFi signal strength</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">wifi_signal</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">WiFi Signal</span>

  <span class="c1"># Reports how long the device has been powered (in minutes)</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">uptime</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Uptime</span>
    <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">return x / 60.0;</span>
    <span class="na">device_class</span><span class="pi">:</span> <span class="s">duration</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">min</span>
    <span class="na">state_class</span><span class="pi">:</span> <span class="s">total_increasing</span>

  <span class="c1"># Reports the Current, Voltage, and Power used by the plugged-in device (not counting this plug's own usage of about 0.7W/0.02A, so subtract those when calibrating with this plugged into a Kill-A-Watt type meter)</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">hlw8012</span>
    <span class="na">sel_pin</span><span class="pi">:</span>
      <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO12</span>
      <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>
    <span class="na">cf_pin</span><span class="pi">:</span> <span class="s">GPIO5</span>
    <span class="na">cf1_pin</span><span class="pi">:</span> <span class="s">GPIO14</span>
    <span class="na">current_resistor</span><span class="pi">:</span> <span class="m">0.001</span> <span class="c1">#The value of the shunt resistor for current measurement. Defaults to the Sonoff POW’s value 0.001 ohm. Verified on https://fccid.io/2AKBP-X10S/Internal-Photos/X10S-Int-photo-4308983 that we use "R001" = 0.001 ohm</span>
    <span class="na">voltage_divider</span><span class="pi">:</span> <span class="m">2401</span> <span class="c1">#The value of the voltage divider on the board as (R_upstream + R_downstream) / R_downstream. Defaults to the Sonoff POW’s value 2351. From the pic we use 2x "125" = 2x 1.2Mohm for R_upstream and "102" = 1kohm for R_downstream, so (1,200,000+1,200,000+1,000)/1,000 = 2401</span>
    <span class="c1"># but those don't fix the measurement values, probably because we actually have a BL0937 chip instead of a HLW8012, (and part variance aswell) so we have to manually calibrate with a known load or a load and a Kill-A-Watt type meter. My values used below will only be +/-10% of yours I think.</span>
    <span class="c1"># The comments about the voltage divider were taken from the AWP04L template. I was unable to verify the voltage divider in the Aoycocr X10S plug.</span>
    <span class="na">power</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Power</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">W</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">wattage</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">0.0 -&gt; </span><span class="m">0.0</span>
            <span class="pi">-</span> <span class="s">196.48288 -&gt; </span><span class="m">35.0</span>
            <span class="pi">-</span> <span class="s">3642.32764 -&gt; </span><span class="m">622.0</span>
            <span class="pi">-</span> <span class="s">6980.42383 -&gt; </span><span class="m">1208.0</span>
            <span class="pi">-</span> <span class="s">7041.69287 -&gt; </span><span class="m">1215.0</span>
        <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">if (id(relay).state) return x; else return 0;</span>
    <span class="na">current</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Current</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">A</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">0.0 -&gt; </span><span class="m">0.0</span>
            <span class="pi">-</span> <span class="s">0.51565 -&gt; </span><span class="m">0.46</span>
            <span class="pi">-</span> <span class="s">7.02498 -&gt; </span><span class="m">7.91</span>
            <span class="pi">-</span> <span class="s">12.91727 -&gt; </span><span class="m">10.96</span>
        <span class="pi">-</span> <span class="na">lambda</span><span class="pi">:</span> <span class="s">if (id(relay).state) return x; else return 0;</span>
    <span class="na">voltage</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Voltage</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">V</span>
      <span class="na">filters</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">calibrate_linear</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">0.0 -&gt; </span><span class="m">0.0</span>
            <span class="pi">-</span> <span class="s">280.19351 -&gt; </span><span class="m">110.7</span>
            <span class="pi">-</span> <span class="s">302.31186 -&gt; </span><span class="m">119.7</span>
            <span class="pi">-</span> <span class="s">306.06781 -&gt; </span><span class="m">123.3</span>
    <span class="na">change_mode_every</span><span class="pi">:</span> <span class="m">1</span> <span class="c1">#Skips first reading after each change, so this will double the update interval. Default 8</span>
    <span class="na">update_interval</span><span class="pi">:</span> <span class="s">10s</span> <span class="c1">#20 second effective update rate for Power, 40 second for Current and Voltage. Default 60s</span>

  <span class="c1"># Reports the total Power so-far each day, resets at midnight, see https://esphome.io/components/sensor/total_daily_energy.html</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">total_daily_energy</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Total Daily Energy</span>
    <span class="na">power_id</span><span class="pi">:</span> <span class="s">wattage</span>
    <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">multiply</span><span class="pi">:</span> <span class="m">0.001</span> <span class="c1">## convert Wh to kWh</span>
    <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s">kWh</span>

<span class="na">text_sensor</span><span class="pi">:</span>
  <span class="c1"># Reports the ESPHome Version with compile date</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">version</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ESPHome Version</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">wifi_info</span>
    <span class="na">ip_address</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">IP Address</span>

<span class="na">switch</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">gpio</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Switch</span>
    <span class="na">pin</span><span class="pi">:</span> <span class="s">GPIO4</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">relay</span>
    <span class="na">restore_mode</span><span class="pi">:</span> <span class="s">ALWAYS_OFF</span>
    <span class="na">on_turn_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">light.turn_on</span><span class="pi">:</span>
          <span class="na">id</span><span class="pi">:</span> <span class="s">blue_led</span>
          <span class="na">brightness</span><span class="pi">:</span> <span class="s">100%</span>
    <span class="na">on_turn_off</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">light.turn_off</span><span class="pi">:</span> <span class="s">blue_led</span>

<span class="na">output</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">esp8266_pwm</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">blue_output</span>
    <span class="na">pin</span><span class="pi">:</span> <span class="s">GPIO2</span>
    <span class="na">inverted</span><span class="pi">:</span> <span class="s">True</span>

<span class="na">light</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">monochromatic</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Blue LED</span>
    <span class="na">output</span><span class="pi">:</span> <span class="s">blue_output</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">blue_led</span>
    <span class="na">restore_mode</span><span class="pi">:</span> <span class="s">ALWAYS_OFF</span>
    <span class="na">disabled_by_default</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">status_led</span><span class="pi">:</span>
  <span class="na">pin</span><span class="pi">:</span>
    <span class="na">number</span><span class="pi">:</span> <span class="s">GPIO0</span>
    <span class="na">inverted</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

  </div>

  <div id="remark42"></div>

  <a class="u-url" href="/2024/08/20/migrate-tasmota-to-esphome.html" hidden></a>
</article>

<script>
  var remark_config = {
    host: 'https://remark.stefandroid.com',
    site_id: 'STEFANDROID_BLOG',
    components: ['embed'],
    url: 'https://blog.stefandroid.com/2024/08/20/migrate-tasmota-to-esphome.html',
    theme: 'light',
    locale: 'en',
    show_email_subscription: false
  };
</script>
<script>!function(e,n){for(var o=0;o<e.length;o++){var r=n.createElement("script"),c=".js",d=n.head||n.body;"noModule"in r?(r.type="module",c=".mjs"):r.async=!0,r.defer=!0,r.src=remark_config.host+"/web/"+e[o]+c,d.appendChild(r)}}(remark_config.components||["embed"],document);</script>

      </div>
    </main><footer class="site-footer h-card">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          
        </ul>
      </div>
    </div>

    <div class="social-links">
      <ul class="social-media-list"><li><a href="https://github.com/stefanthoss" target="_blank"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">stefanthoss</span></a></li><li><a rel="me" href="https://sfba.social/@stefandroid" target="_blank"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#mastodon"></use></svg> <span>Mastodon</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>Subscribe via Atom</span></a></li></ul>      
    </div>

  </div>

</footer>
</body>

</html>
